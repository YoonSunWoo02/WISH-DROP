# Wish Drop â€” Cursor AI ì»¨í…ìŠ¤íŠ¸ íŒŒì¼
# ì´ íŒŒì¼ì„ í”„ë¡œì íŠ¸ ë£¨íŠ¸ì— `.cursorrules` ë˜ëŠ” `CLAUDE.md`ë¡œ ì €ì¥í•˜ì„¸ìš”.
# Cursorê°€ ì´ íŒŒì¼ì„ ìë™ìœ¼ë¡œ ì½ê³  í”„ë¡œì íŠ¸ ì „ì²´ ì»¨í…ìŠ¤íŠ¸ë¡œ í™œìš©í•©ë‹ˆë‹¤.

---

## ğŸ§  ë„ˆëŠ” ì§€ê¸ˆ ì–´ë–¤ í”„ë¡œì íŠ¸ë¥¼ ë³´ê³  ìˆëŠ”ê°€

**Wish Drop**ì€ ì§€ì¸ ê¸°ë°˜ ì†Œì…œ ì„ ë¬¼ í€ë”© ì•±ì´ë‹¤.
ì‚¬ìš©ìê°€ ë°›ê³  ì‹¶ì€ ì„ ë¬¼(ìœ„ì‹œ)ì„ ì˜¬ë¦¬ë©´, ì¹œêµ¬ë“¤ì´ ì¹´ì¹´ì˜¤í˜ì´ë¡œ ì†Œì•¡ì”© í›„ì›í•´ ëª©í‘œ ê¸ˆì•¡ì„ ì±„ì›Œì£¼ëŠ” ì„œë¹„ìŠ¤ë‹¤.

ê¸°ìˆ  ìŠ¤íƒì€ ì•„ë˜ì™€ ê°™ë‹¤:
- **Frontend**: Flutter (Dart)
- **Backend/DB**: Supabase (PostgreSQL + Auth + Edge Functions)
- **ê²°ì œ**: PortOne V2 SDK (`portone_flutter_v2`) â€” ì¹´ì¹´ì˜¤í˜ì´ ì—°ë™
- **ì„œë²„ ë¡œì§**: Deno (Supabase Edge Functions, í˜„ì¬ ë¯¸ë°°í¬)

---

## ğŸ“ í´ë” êµ¬ì¡° & ê° íŒŒì¼ì˜ ì—­í• 

```
lib/
â”œâ”€â”€ features/
â”‚   â”œâ”€â”€ donation/                        # í›„ì›(ê²°ì œ) ê¸°ëŠ¥ ì „ì²´
â”‚   â”‚   â”œâ”€â”€ data/
â”‚   â”‚   â”‚   â””â”€â”€ donation_repository.dart
â”‚   â”‚   â”‚       # Supabaseì™€ ì§ì ‘ í†µì‹ í•˜ëŠ” ìœ ì¼í•œ í´ë˜ìŠ¤
â”‚   â”‚   â”‚       # donations í…Œì´ë¸” INSERT
â”‚   â”‚   â”‚       # projects.current_amount UPDATE
â”‚   â”‚   â”œâ”€â”€ presentation/
â”‚   â”‚   â”‚   â”œâ”€â”€ donation_input_page.dart
â”‚   â”‚   â”‚   â”‚   # ì‚¬ìš©ì ì…ë ¥ UI + ì „ì²´ ê²°ì œ íë¦„ ì œì–´ (í•µì‹¬ í˜ì´ì§€)
â”‚   â”‚   â”‚   â”‚   # PaymentService í˜¸ì¶œ â†’ PaymentWebViewPage push â†’ ê²°ê³¼ ì²˜ë¦¬
â”‚   â”‚   â”‚   â”œâ”€â”€ payment_webview_page.dart
â”‚   â”‚   â”‚   â”‚   # PortOne ê²°ì œì°½ë§Œ ë„ìš°ëŠ” ìˆœìˆ˜ ë·°
â”‚   â”‚   â”‚   â”‚   # UI ë¡œì§ ì—†ìŒ. ê²°ì œ ê²°ê³¼ë§Œ ì½œë°±ìœ¼ë¡œ ë°˜í™˜
â”‚   â”‚   â”‚   â””â”€â”€ donation_success_page.dart
â”‚   â”‚   â”‚       # ê²°ì œ ì„±ê³µ í›„ ë„ë‹¬í•˜ëŠ” ìµœì¢… í™”ë©´
â”‚   â”‚   â”‚       # pushAndRemoveUntilë¡œ ì´ì „ ê²°ì œ ìŠ¤íƒ ì „ë¶€ ì œê±° í›„ ì´ë™
â”‚   â”‚   â””â”€â”€ services/
â”‚   â”‚       â””â”€â”€ payment_service.dart
â”‚   â”‚           # ê²°ì œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì˜ í•µì‹¬
â”‚   â”‚           # .envì—ì„œ PORTONE_STORE_ID, PORTONE_CHANNEL_KEY ë¡œë“œ
â”‚   â”‚           # ê³ ìœ  ê²°ì œ ID ìƒì„±: "pay_{timestamp}_{random4ìë¦¬}"
â”‚   â”‚           # PortOne SDKì— ë„˜ê¸¸ ê²°ì œ ë°ì´í„° ê°ì²´ ì¡°ë¦½
â”‚   â”‚
â”‚   â”œâ”€â”€ wish/                            # ìœ„ì‹œ í”„ë¡œì íŠ¸ ê¸°ëŠ¥
â”‚   â”‚   â”œâ”€â”€ data/
â”‚   â”‚   â”‚   â”œâ”€â”€ project_repository.dart  # projects í…Œì´ë¸” CRUD
â”‚   â”‚   â”‚   â””â”€â”€ project_model.dart       # DB row â†’ Dart ê°ì²´ ë³€í™˜ (fromJson)
â”‚   â”‚   â””â”€â”€ presentation/
â”‚   â”‚       â”œâ”€â”€ home_page.dart           # ì „ì²´ ìœ„ì‹œ ëª©ë¡ í”¼ë“œ
â”‚   â”‚       â”œâ”€â”€ product_detail_page.dart # ìœ„ì‹œ ìƒì„¸ + "í›„ì›í•˜ê¸°" ë²„íŠ¼ â†’ DonationInputPageë¡œ ì´ë™
â”‚   â”‚       â””â”€â”€ create_wish_page.dart    # ìƒˆ ìœ„ì‹œ ìƒì„± í¼
â”‚   â”‚
â”‚   â””â”€â”€ profile/                         # ë‚´ ì •ë³´ (ì§„í–‰ ì¤‘)
â”‚       â””â”€â”€ presentation/
â”‚           â””â”€â”€ my_wish_process_page.dart
â”‚               # ë‚´ê°€ ë§Œë“  ìœ„ì‹œ ëª©ë¡ ì¡°íšŒ
â”‚               # í´ë¦­ ì‹œ product_detail_pageë¡œ ì´ë™
â”‚
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ theme.dart      # ì•± ì „ì—­ ìƒ‰ìƒ/í°íŠ¸ í…Œë§ˆ
â”‚   â””â”€â”€ constants.dart  # ìƒìˆ˜ (wishdrop:// redirect URL ë“±)
â”‚
â””â”€â”€ main.dart           # ì•± ì§„ì…ì , Supabase ì´ˆê¸°í™”
```

---

## ğŸ—„ ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ

### í…Œì´ë¸” ê´€ê³„
```
users (Supabase Auth ê¸°ë³¸ ì œê³µ)
  â””â”€â”€â”€ 1:N â”€â”€â”€â–º projects   (user_idë¡œ ì—°ê²°, ìœ„ì‹œë¥¼ ë§Œë“  ì‚¬ëŒ)
                  â””â”€â”€â”€ 1:N â”€â”€â”€â–º donations  (project_idë¡œ ì—°ê²°, í›„ì› ë‚´ì—­)
users â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º donations  (user_idë¡œ ì—°ê²°, í›„ì›í•œ ì‚¬ëŒ)
```

### projects í…Œì´ë¸”
```sql
id             int8      PK, ìë™ì¦ê°€
user_id        uuid      FK â†’ auth.users.id  (ìœ„ì‹œë¥¼ ë§Œë“  ì‚¬ìš©ì)
title          text      ì„ ë¬¼ ì´ë¦„
target_amount  int8      ëª©í‘œ ê¸ˆì•¡ (ë‹¨ìœ„: ì›)
current_amount int8      í˜„ì¬ ëª¨ê¸ˆì•¡. í›„ì› ë°œìƒ ì‹œ UPDATEë¨
status         text      'active' | 'completed' | 'deleted'
created_at     timestamp ìƒì„±ì¼
```

### donations í…Œì´ë¸”
```sql
id            int8      PK, ìë™ì¦ê°€
project_id    int8      FK â†’ projects.id
user_id       uuid      FK â†’ auth.users.id  (í›„ì›í•œ ì‚¬ìš©ì)
amount        int8      í›„ì› ê¸ˆì•¡ (ë‹¨ìœ„: ì›)
message       text      ì‘ì› ë©”ì‹œì§€
is_anonymous  boolean   ìµëª… ì—¬ë¶€ (default: false)
payment_id    text      PortOne ê²°ì œ ID. ì¤‘ë³µ ë°©ì§€ìš© unique í‚¤
created_at    timestamp í›„ì›ì¼
```

### âš ï¸ RLS (Row Level Security) ì •ì±… â€” ì ˆëŒ€ ê±´ë“œë¦¬ì§€ ë§ ê²ƒ
ì•„ë˜ ì •ì±…ì€ ì´ë¯¸ ìˆ˜ì • ì™„ë£Œëœ ìƒíƒœë‹¤. ì½”ë“œ ìˆ˜ì • ì‹œ ë¡¤ë°±í•˜ì§€ ì•Šë„ë¡ ì£¼ì˜.

| í…Œì´ë¸” | ì‘ì—… | í—ˆìš© ì¡°ê±´ |
|--------|------|-----------|
| projects | SELECT | ëª¨ë“  ìœ ì € (public) |
| projects | INSERT | auth.uid() = user_id |
| projects | UPDATE | **ì¸ì¦ëœ ëª¨ë“  ìœ ì €** â† current_amount ì¦ê°€ë¥¼ ìœ„í•´ ì—´ë ¤ ìˆìŒ |
| projects | DELETE | auth.uid() = user_id |
| donations | SELECT | auth.uid() = user_id |
| donations | INSERT | **ì¸ì¦ëœ ëª¨ë“  ìœ ì €** â† í›„ì› ì €ì¥ì„ ìœ„í•´ ì—´ë ¤ ìˆìŒ |

---

## ğŸ’³ ê²°ì œ í”Œë¡œìš° â€” ì½”ë“œ ìˆ˜ì • ì‹œ ë°˜ë“œì‹œ ì´ ìˆœì„œë¥¼ ì§€ì¼œì•¼ í•œë‹¤

```
[1] DonationInputPage
    ì‚¬ìš©ìê°€ ê¸ˆì•¡, ë©”ì‹œì§€, ìµëª… ì—¬ë¶€ ì…ë ¥

[2] PaymentService.buildPaymentData() í˜¸ì¶œ
    â†’ generatePaymentId()ë¡œ "pay_{timestamp}_{random4}" ìƒì„±
    â†’ .envì—ì„œ storeId, channelKey ë¡œë“œ
    â†’ PortOnePayment ê°ì²´ ë°˜í™˜

[3] PaymentWebViewPage push
    â†’ PortOne SDKê°€ KakaoPay ê²°ì œì°½ WebView ë Œë”ë§

[4] ê²°ì œ ì™„ë£Œ ì‹œ wishdrop:// ë”¥ë§í¬ë¡œ ì•± ë³µê·€
    â†’ ì„±ê³µ ì½œë°± / ì‹¤íŒ¨ ì½œë°± ë¶„ê¸°

[5] ì„±ê³µ ì‹œ DonationRepository í˜¸ì¶œ
    â†’ donations í…Œì´ë¸” INSERT
    â†’ projects.current_amount += amount UPDATE

[6] DonationSuccessPageë¡œ pushAndRemoveUntil ì´ë™
    (ê²°ì œ ì¤‘ê°„ ìŠ¤íƒ ì „ë¶€ ì œê±° â€” ë’¤ë¡œê°€ê¸°ë¡œ ê²°ì œì°½ ì¬ì§„ì… ë°©ì§€)
```

### ì´ë¯¸ í•´ê²°ëœ ë²„ê·¸ (ì ˆëŒ€ ë¡¤ë°± ê¸ˆì§€)
- âœ… **ê²°ì œ ID ì¤‘ë³µ ë¬¸ì œ**: `pay_{timestamp}_{random4}` ì¡°í•©ìœ¼ë¡œ í•´ê²°ë¨
- âœ… **RLS ê¶Œí•œ ê±°ë¶€**: projects UPDATE, donations INSERT ì •ì±… ìˆ˜ì • ì™„ë£Œ
- âœ… **Redirect URL ìŠ¤í‚´**: `wishdrop://` ì„¤ì • ì™„ë£Œ

---

## ğŸ”‘ í•µì‹¬ í´ë˜ìŠ¤ ì¸í„°í˜ì´ìŠ¤

### PaymentService
```dart
// lib/features/donation/services/payment_service.dart

class PaymentService {
  final String storeId;    // PORTONE_STORE_ID (.env)
  final String channelKey; // PORTONE_CHANNEL_KEY (.env)

  // "pay_{í˜„ì¬ì‹œê°ë°€ë¦¬ì´ˆ}_{4ìë¦¬ëœë¤}" í˜•íƒœë¡œ ê³ ìœ  ID ìƒì„±
  String generatePaymentId();

  // PortOne SDKì— ë„˜ê¸¸ ê²°ì œ ìš”ì²­ ê°ì²´ ì¡°ë¦½
  PortOnePayment buildPaymentData({
    required int amount,
    required String orderName,
    required String customerId,
  });
}
```

### DonationRepository
```dart
// lib/features/donation/data/donation_repository.dart

class DonationRepository {
  final SupabaseClient supabase;

  // donations í…Œì´ë¸”ì— í›„ì› ë‚´ì—­ INSERT
  Future<void> insertDonation({
    required int projectId,
    required String userId,
    required int amount,
    required String message,
    required bool isAnonymous,
    required String paymentId, // ì¤‘ë³µë°©ì§€ìš©, PortOne ê²°ì œ ID ê·¸ëŒ€ë¡œ ì €ì¥
  });

  // projects.current_amount += addedAmount (ì›ìì  UPDATE)
  Future<void> updateCurrentAmount({
    required int projectId,
    required int addedAmount,
  });
}
```

### ProjectRepository
```dart
// lib/features/wish/data/project_repository.dart

class ProjectRepository {
  final SupabaseClient supabase;

  Future<List<ProjectModel>> fetchProjects();             // í™ˆ í”¼ë“œìš© ì „ì²´ ëª©ë¡
  Future<List<ProjectModel>> fetchMyProjects(String uid); // ë‚´ ìœ„ì‹œ ëª©ë¡
  Future<void> createProject({...});                      // ìœ„ì‹œ ìƒì„±
  Future<void> updateStatus(int id, String status);       // â† ë¯¸êµ¬í˜„, To-Do
}
```

### ProjectModel
```dart
// lib/features/wish/data/project_model.dart

class ProjectModel {
  final int id;
  final String userId;
  final String title;
  final int targetAmount;
  final int currentAmount;
  final String status; // 'active' | 'completed' | 'deleted'
  final DateTime createdAt;

  double get progressRate => currentAmount / targetAmount; // 0.0 ~ 1.0+
  bool get isCompleted => status == 'completed';

  factory ProjectModel.fromJson(Map<String, dynamic> json);
}
```

---

## ğŸš§ í˜„ì¬ ë¯¸êµ¬í˜„ / ì‘ì—… ì¤‘ì¸ ê¸°ëŠ¥ (To-Do)

### ìš°ì„ ìˆœìœ„ ë†’ìŒ
1. **ê²°ì œ ì„œë²„ ê²€ì¦ (Edge Function)**
   - í˜„ì¬ í´ë¼ì´ì–¸íŠ¸ê°€ ì§ì ‘ DBë¥¼ ì—…ë°ì´íŠ¸ ì¤‘ â†’ ë³´ì•ˆ ì·¨ì•½
   - ëª©í‘œ: PortOne WebHook â†’ Deno Edge Function â†’ ê²°ì œ ì¬ê²€ì¦ â†’ DB UPDATE
   - íŒŒì¼ ìœ„ì¹˜ ì˜ˆì •: `supabase/functions/verify-payment/index.ts`
   - ë°°í¬ ëª…ë ¹: `supabase functions deploy verify-payment`
   - í™˜ê²½ë³€ìˆ˜: `PORTONE_SECRET_KEY` Supabase secretsì— ë“±ë¡ í•„ìš”

2. **í”„ë¡œì íŠ¸ ì™„ë£Œ ìë™í™”**
   - `current_amount >= target_amount` ì¡°ê±´ ë‹¬ì„± ì‹œ `status = 'completed'` ìë™ ì „í™˜
   - ProjectRepository.updateStatus() êµ¬í˜„ í•„ìš”

### ìš°ì„ ìˆœìœ„ ì¤‘ê°„
3. **"ì™„ë£Œë¨" íƒ­** â€” MyWishProcessPageì— status í•„í„° íƒ­ ì¶”ê°€
4. **í›„ì›ì ëª©ë¡ UI** â€” donations ì¡°íšŒ, is_anonymous ì‹œ "ìµëª…ì˜ ì¹œêµ¬" í‘œì‹œ

### ìš°ì„ ìˆœìœ„ ë‚®ìŒ
5. SNS ê³µìœ , í‘¸ì‹œ ì•Œë¦¼

---

## ğŸ“Œ ì½”ë“œ ì‘ì„± ê·œì¹™ (Cursorê°€ ìƒˆ ì½”ë“œë¥¼ ìƒì„±í•  ë•Œ ë°˜ë“œì‹œ ë”°ë¥¼ ê²ƒ)

1. **UIì™€ ë¡œì§ì„ ë¶„ë¦¬í•œë‹¤.** PageëŠ” íë¦„ ì œì–´ë§Œ, ì‹¤ì œ ë¡œì§ì€ Service/Repositoryì— ìœ„ì„í•œë‹¤.
2. **Supabase ì ‘ê·¼ì€ Repository í´ë˜ìŠ¤ì—ì„œë§Œ** í•œë‹¤. Pageì—ì„œ ì§ì ‘ `supabase.from(...)` í˜¸ì¶œ ê¸ˆì§€.
3. **ê²°ì œ IDëŠ” í•­ìƒ PaymentService.generatePaymentId()ë¡œ** ìƒì„±í•œë‹¤. ì§ì ‘ í•˜ë“œì½”ë”© ê¸ˆì§€.
4. **RLS ì •ì±…ì„ ë°”ê¾¸ëŠ” SQLì€ ì‘ì„±í•˜ì§€ ì•ŠëŠ”ë‹¤.** ì´ë¯¸ ì˜¬ë°”ë¥´ê²Œ ì„¤ì •ë˜ì–´ ìˆë‹¤.
5. **ê²°ì œ ì„±ê³µ í›„ í˜ì´ì§€ ì´ë™ì€ ë°˜ë“œì‹œ pushAndRemoveUntil**ì„ ì‚¬ìš©í•œë‹¤. push ë‹¨ë… ì‚¬ìš© ê¸ˆì§€.
6. **status ê°’ì€ ë¬¸ìì—´ ë¦¬í„°ëŸ´ ëŒ€ì‹  ìƒìˆ˜ë¡œ** ì •ì˜í•´ ì‚¬ìš©í•œë‹¤. (`'active'`, `'completed'`, `'deleted'`)
7. **ìµëª… í›„ì›ì í‘œì‹œ** ì‹œ `is_anonymous == true`ì´ë©´ ì´ë¦„ ëŒ€ì‹  "ìµëª…ì˜ ì¹œêµ¬"ë¥¼ ë Œë”ë§í•œë‹¤.
8. **í™˜ê²½ë³€ìˆ˜**ëŠ” `.env` íŒŒì¼ì—ì„œë§Œ ì½ëŠ”ë‹¤. í‚¤ë¥¼ ì½”ë“œì— í•˜ë“œì½”ë”©í•˜ì§€ ì•ŠëŠ”ë‹¤.
